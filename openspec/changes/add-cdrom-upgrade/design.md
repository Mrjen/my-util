# Design: CD-ROM 升级功能

## Context

当前软件升级页面仅支持固件升级，流程为：连接设备 → 进入 IAP 模式（设备断开重连）→ 重新连接 → 写入固件。CD-ROM 升级是一种更简单的升级方式，不需要设备模式切换，可以直接在当前连接状态下完成升级。

### 约束

- 必须复用现有的 HID 通信基础设施
- 需要兼容现有固件升级功能
- UI 改动应最小化，保持一致的用户体验

## Goals / Non-Goals

### Goals

- 支持 CD-ROM bin 文件升级
- 简化升级流程（无需 IAP 模式切换）
- 提供清晰的升级进度反馈
- 复用现有代码结构

### Non-Goals

- 不修改现有固件升级流程
- 不支持同时进行两种升级
- 不增加额外的设备管理功能

## Decisions

### Decision 1: 共用 Hook vs 独立 Hook

**选择**: 扩展现有 `useFirmwareUpgrade` hook

**原因**:
- CD-ROM 升级共享大部分状态管理逻辑（设备连接、日志、进度）
- 避免代码重复
- 保持单一的设备连接管理入口

**替代方案**: 创建独立的 `useCdromUpgrade` hook
- 优点: 关注点分离更清晰
- 缺点: 需要协调两个 hook 的设备状态

### Decision 2: 数据包大小

根据协议文档：
- 一包总大小: 58 字节 + 1 报告 ID = 59 字节
- 协议开销: 11 字节 (帧头 6 + 帧尾 3 + CRC 2)
- 有效数据: 47 字节/包

### Decision 3: 响应读取策略

**选择**: 每包发送后延迟 15ms，然后读取 Feature Report 获取响应

**原因**:
- 协议要求发送后延迟 15ms
- 需要确认设备接收的包数
- 可检测传输错误

## Risks / Trade-offs

### Risk 1: 响应读取可能失败

- **风险**: WebHID 的 `receiveFeatureReport` 可能因设备不支持而失败
- **缓解**: 添加 try-catch 处理，失败时记录警告但继续发送（降级为不确认模式）

### Risk 2: 大文件升级时间较长

- **风险**: CD-ROM 文件可能较大（如 145KB），按 47 字节/包需要约 3000+ 包
- **缓解**: 提供详细的进度显示和日志

## Migration Plan

无需迁移，这是新增功能。

## Open Questions

1. ~~是否需要验证设备返回的包数与发送包数匹配？~~ **已确定**: 需要验证，如果不匹配则报错
2. CD-ROM 升级完成后是否需要发送特定的结束命令？**待确认**: 协议文档中未提及
